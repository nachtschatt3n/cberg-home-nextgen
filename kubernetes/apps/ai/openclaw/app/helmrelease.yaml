---
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: openclaw
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.7.3
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  maxHistory: 1
  install:
    timeout: 15m
    remediation:
      retries: 3
  upgrade:
    timeout: 15m
    cleanupOnFail: false
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    controllers:
      openclaw:
        pod:
          annotations:
            secret.reloader.stakater.com/reload: openclaw-secret
          securityContext:
            fsGroup: 1000
            fsGroupChangePolicy: OnRootMismatch

        initContainers:
          install-openclaw:
            image:
              repository: node
              tag: 22-bookworm
            command:
              - bash
              - -lc
              - |
                set -euo pipefail

                # Migrate .clawdbot -> .openclaw if needed
                if [ -d "/home/node/.clawdbot" ] && [ ! -L "/home/node/.clawdbot" ]; then
                  echo "Migrating .clawdbot → .openclaw..."
                  mv /home/node/.clawdbot /home/node/.openclaw
                  ln -sf /home/node/.openclaw /home/node/.clawdbot
                fi

                # Migrate old clawdbot.json -> openclaw.json
                if [ -f "/home/node/.openclaw/clawdbot.json" ] && [ ! -f "/home/node/.openclaw/openclaw.json" ]; then
                  echo "Renaming clawdbot.json → openclaw.json..."
                  mv /home/node/.openclaw/clawdbot.json /home/node/.openclaw/openclaw.json
                fi

                # Remove stale gateway auth from config files
                for cfg in /home/node/.openclaw/openclaw.json /home/node/.openclaw/clawdbot.json; do
                  if [ -f "$cfg" ] && grep -q '"auth"' "$cfg" 2>/dev/null; then
                    echo "Removing stale gateway.auth from $cfg..."
                    node -e "
                      const fs = require('fs');
                      const cfg = JSON.parse(fs.readFileSync('$cfg','utf8'));
                      if (cfg.gateway && cfg.gateway.auth) { delete cfg.gateway.auth; }
                      fs.writeFileSync('$cfg', JSON.stringify(cfg, null, 2));
                    "
                  fi
                done

                export HOME="/home/node/.openclaw"
                mkdir -p "$HOME"
                export NPM_CONFIG_CACHE="/home/node/.npm"
                mkdir -p "$NPM_CONFIG_CACHE"
                export PYTHONUSERBASE="/home/node/.openclaw"
                echo "Cleaning existing runtimes to free space..."
                rm -rf /home/node/.openclaw/.cache
                export PYTHONPATH="/home/node/.openclaw/lib/python3.12/site-packages"
                export PIP_DISABLE_PIP_VERSION_CHECK=1

                echo "Installing git and build dependencies..."
                apt-get update
                DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
                  bash \
                  python3 python3-pip python3-venv python3-dev \
                  build-essential pkg-config \
                  git openssh-client ca-certificates curl sudo \
                  libatlas-base-dev libopenblas-dev libssl-dev libffi-dev

                echo "Configuring passwordless sudo for node user..."
                useradd -u 1000 -m -s /bin/bash node || true
                echo "node ALL=(ALL:ALL) NOPASSWD: ALL" > /etc/sudoers.d/node
                chmod 0440 /etc/sudoers.d/node
                echo "Passwordless sudo configured for user 'node'"

                BIN_DIR="/home/node/.openclaw/bin"
                mkdir -p "$BIN_DIR"
                ln -sf /usr/bin/git "$BIN_DIR/git"
                ln -sf /usr/bin/python3 "$BIN_DIR/python3"
                rm -f "$BIN_DIR/gh" "$BIN_DIR/jq" "$BIN_DIR/ffmpeg" "$BIN_DIR/ffprobe"

                echo "Installing kubectl..."
                # Use a known stable version as fallback if latest check fails
                KUBECTL_VER="$(curl -L -s https://dl.k8s.io/release/stable.txt 2>/dev/null || echo 'v1.31.4')"
                echo "Kubectl version: ${KUBECTL_VER}"
                KUBECTL_URL="https://dl.k8s.io/release/${KUBECTL_VER}/bin/linux/amd64/kubectl"
                if curl -L -f "${KUBECTL_URL}" -o "$BIN_DIR/kubectl" 2>/dev/null; then
                  chmod +x "$BIN_DIR/kubectl"
                  echo "kubectl installed successfully"
                  "$BIN_DIR/kubectl" version --client --short 2>/dev/null || true
                else
                  echo "Failed to download kubectl from ${KUBECTL_URL}, trying v1.31.4..."
                  # Fallback to known version
                  if curl -L -f "https://dl.k8s.io/release/v1.31.4/bin/linux/amd64/kubectl" -o "$BIN_DIR/kubectl"; then
                    chmod +x "$BIN_DIR/kubectl"
                    echo "kubectl v1.31.4 installed successfully"
                  else
                    echo "kubectl installation failed"
                  fi
                fi

                echo "Installing mise..."
                MISE_TMP="$(mktemp -d)"
                curl -fsSL https://mise.jdx.dev/install.sh -o "${MISE_TMP}/install.sh"
                sh "${MISE_TMP}/install.sh" --yes --bin-dir "$BIN_DIR"
                rm -rf "${MISE_TMP}"

                echo "Installing gh CLI..."
                rm -rf /tmp/gh-cli
                mkdir -p /tmp/gh-cli
                cd /tmp/gh-cli
                if apt-get download gh; then
                  dpkg -x gh_*.deb /tmp/gh-cli
                else
                  echo "Failed to download gh via apt" >&2
                  exit 1
                fi
                if [ ! -x "/tmp/gh-cli/usr/bin/gh" ]; then
                  echo "Failed to unpack gh CLI" >&2
                  exit 1
                fi
                cp "/tmp/gh-cli/usr/bin/gh" "$BIN_DIR/gh"
                chmod +x "$BIN_DIR/gh"
                rm -rf /tmp/gh-cli gh_*.deb
                rm -rf /var/lib/apt/lists/*
                cd "$HOME"

                echo "Installing jq..."
                curl -fsSL "https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux-amd64" -o "$BIN_DIR/jq"
                chmod +x "$BIN_DIR/jq"

                echo "Installing ffmpeg static build..."
                FFMPEG_TMP="$(mktemp -d)"
                curl -fsSL "https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz" -o "$FFMPEG_TMP/ffmpeg.tar.xz"
                tar -xf "$FFMPEG_TMP/ffmpeg.tar.xz" -C "$FFMPEG_TMP"
                FFMPEG_DIR="$(find "$FFMPEG_TMP" -maxdepth 1 -type d -name 'ffmpeg-*static' | head -n 1)"
                if [ -z "$FFMPEG_DIR" ]; then
                  echo "Failed to unpack ffmpeg" >&2
                  exit 1
                fi
                cp "$FFMPEG_DIR/ffmpeg" "$BIN_DIR/ffmpeg"
                cp "$FFMPEG_DIR/ffprobe" "$BIN_DIR/ffprobe"
                chmod +x "$BIN_DIR/ffmpeg" "$BIN_DIR/ffprobe"
                rm -rf "$FFMPEG_TMP"

                echo "Linking tools into /usr/local/bin for interactive shells..."
                for tool in "$BIN_DIR"/*; do
                  [ -f "$tool" ] || continue
                  ln -sf "$tool" "/usr/local/bin/$(basename "$tool")"
                done

                echo "Installing openclaw CLI + coding agent runtimes to shared volume..."
                export PATH="/home/node/.openclaw/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
                export LD_LIBRARY_PATH="/usr/local/lib:/usr/lib:/lib"
                export GIT_EXEC_PATH="/usr/lib/git-core"
                export GIT_SSH_COMMAND="ssh -oStrictHostKeyChecking=accept-new"
                rm -f "$HOME/.gitconfig"
                git config --system --add url."https://github.com/".insteadOf "ssh://git@github.com/"
                git config --system --add url."https://github.com/".insteadOf "ssh://git@github.com"
                git config --system --add url."https://github.com/".insteadOf "git@github.com:"
                git config --system --add url."https://github.com/".insteadOf "git@github.com"
                git config --system --add url."https://github.com/".insteadOf "git+ssh://git@github.com/"
                git config --system --add url."https://github.com/".insteadOf "git+ssh://git@github.com"
                git config --system --add url."https://github.com/".insteadOf "git://github.com/"
                git config --system --add url."https://github.com/".insteadOf "git://github.com"
                git config --global --add url."https://github.com/".insteadOf "ssh://git@github.com/"
                git config --global --add url."https://github.com/".insteadOf "ssh://git@github.com"
                git config --global --add url."https://github.com/".insteadOf "git@github.com:"
                git config --global --add url."https://github.com/".insteadOf "git@github.com"
                git config --global --add url."https://github.com/".insteadOf "git+ssh://git@github.com/"
                git config --global --add url."https://github.com/".insteadOf "git+ssh://git@github.com"
                git config --global --add url."https://github.com/".insteadOf "git://github.com/"
                git config --global --add url."https://github.com/".insteadOf "git://github.com"
                git config -l --show-origin | grep url || true

                install_npm() {
                  pkg="$1"
                  echo "npm install -g $pkg..."
                  if ! npm install -g --prefix /home/node/.openclaw "$pkg"; then
                    echo "WARN: npm install failed for $pkg (continuing)"
                  fi
                }
                install_pip() {
                  pkg="$1"
                  echo "pip install $pkg..."
                  if ! timeout 240 python3 -m pip install --user --no-cache-dir --break-system-packages "$pkg"; then
                    echo "WARN: pip install failed for $pkg (continuing)"
                  fi
                }

                install_npm openclaw@latest
                install_npm @openai/codex
                install_npm @google/gemini-cli
                install_npm claude
                install_npm @mariozechner/pi-coding-agent
                install_npm clawdhub
                install_npm mcporter
                install_npm goplaces
                install_npm gog
                install_npm opencode-ai
                install_npm summarize
                install_npm sag

                export PIP_ROOT_USER_ACTION=ignore
                install_pip obsidian-cli
                install_pip himalaya
                install_pip openai-whisper

                echo "Creating symlink..."
                ln -sf /home/node/.openclaw/bin/openclaw /home/node/.openclaw/openclaw
                echo "OpenClaw installed at: /home/node/.openclaw/bin/openclaw"
                /home/node/.openclaw/bin/openclaw --version
                echo "Seeding Ollama auth profile..."
                AUTH_DIR="/home/node/.openclaw/agents/main/agent"
                mkdir -p "$AUTH_DIR"
                printf '%s\n' \
                  '{' \
                  '  "ollama": {' \
                  '    "api_key": "ollama",' \
                  '    "api_base": "http://192.168.30.111:11435/v1"' \
                  '  }' \
                  '}' > "$AUTH_DIR/auth-profiles.json"

                echo "Fixing permissions..."
                chown -R 1000:1000 /home/node/.openclaw
                # Fix ownership of backward-compat symlink created during migration
                chown -h 1000:1000 /home/node/.clawdbot 2>/dev/null || true
            env:
              # GitHub token for mise and git operations during init
              - name: GITHUB_TOKEN
                valueFrom:
                  secretKeyRef:
                    name: openclaw-secret
                    key: GITHUB_TOKEN
            securityContext:
              runAsUser: 0
              runAsGroup: 0

        containers:
          app:
            image:
              repository: node
              tag: 22-bookworm
              pullPolicy: IfNotPresent

            command:
              - bash
              - -lc
              - |
                set -euo pipefail

                export PATH="/home/node/.openclaw/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
                export LD_LIBRARY_PATH="/usr/local/lib:/usr/lib:/lib"
                export GIT_EXEC_PATH="/usr/lib/git-core"
                export PYTHONUSERBASE="/home/node/.openclaw"
                export PYTHONPATH="/home/node/.openclaw/lib/python3.12/site-packages"
                CONFIG_PATH="/home/node/.openclaw/openclaw.json"
                STATE_DIR="/home/node/.openclaw"

                mkdir -p "$STATE_DIR" /home/node/clawd /home/node/.ssh
                SHELL_PATH="/home/node/.openclaw/bin:/home/node/.local/bin:/home/node/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
                for f in .bashrc .profile .bash_logout; do
                  if [ ! -f "/home/node/$f" ] && [ -f "/etc/skel/$f" ]; then
                    cp "/etc/skel/$f" "/home/node/$f"
                  fi
                done
                if ! grep -q "OPENCLAW_PATH_EXPORT" /home/node/.bashrc 2>/dev/null; then
                  printf '\n# OPENCLAW_PATH_EXPORT\nexport PATH="%s:$PATH"\n' "$SHELL_PATH" >> /home/node/.bashrc
                fi
                if ! grep -q "OPENCLAW_PATH_EXPORT" /home/node/.profile 2>/dev/null; then
                  printf '\n# OPENCLAW_PATH_EXPORT\nexport PATH="%s:$PATH"\n' "$SHELL_PATH" >> /home/node/.profile
                fi
                chown -R 1000:1000 /home/node 2>/dev/null || true

                node - <<'NODE'
                  const fs = require('fs');
                  const path = '/home/node/.openclaw/openclaw.json';
                  const modelName = process.env.OLLAMA_MODEL || 'gpt-oss:20b';
                  const ollamaBase = process.env.OLLAMA_BASE || 'http://192.168.30.111:11435/v1';
                  const ollamaKey = process.env.OLLAMA_API_KEY || 'ollama';
                  const displayModel = modelName.includes('/') ? modelName : 'ollama/' + modelName;
                  const modelId = displayModel;
                  const baseCfg = {
                    gateway: {
                      mode: 'local',
                      bind: 'lan',
                      port: 18789,
                      trustedProxies: ['10.69.0.35', '10.0.0.0/8', '192.168.0.0/16', '172.16.0.0/12', '127.0.0.1', 'localhost', '::1'],
                    },
                    agents: {
                      defaults: {
                        workspace: '/home/node/clawd',
                        model: { primary: modelId },
                      },
                    },
                    models: {
                      providers: {
                        ollama: {
                          baseUrl: ollamaBase,
                          apiKey: ollamaKey,
                          api: 'openai-completions',
                          models: [{
                            id: modelName,
                            name: modelName,
                            reasoning: false,
                            input: ['text'],
                            cost: { input: 0, output: 0, cacheRead: 0, cacheWrite: 0 },
                            contextWindow: 32768,
                            maxTokens: 4096,
                          }],
                        },
                      },
                    },
                  };

                  // Load existing config if it exists, otherwise start with baseCfg
                  let cfg = baseCfg;
                  if (fs.existsSync(path)) {
                    try {
                      const existing = JSON.parse(fs.readFileSync(path, 'utf8'));
                      // Preserve existing config but update key sections
                      cfg = existing;
                    } catch (e) {
                      console.log('Failed to parse existing config, using defaults:', e.message);
                    }
                  }

                  // Update gateway settings (preserve other gateway fields like devices)
                  cfg.gateway = cfg.gateway || {};
                  cfg.gateway.mode = cfg.gateway.mode || 'local';
                  cfg.gateway.bind = cfg.gateway.bind || 'lan';
                  cfg.gateway.port = cfg.gateway.port || 18789;
                  cfg.gateway.trustedProxies = ['10.69.0.35', '10.0.0.0/8', '192.168.0.0/16', '172.16.0.0/12', '127.0.0.1', 'localhost', '::1'];

                  // Remove stale auth config — gateway runs without auth on internal ingress
                  delete cfg.gateway.auth;

                  // Update agents defaults
                  cfg.agents = cfg.agents || {};
                  cfg.agents.defaults = cfg.agents.defaults || {};
                  cfg.agents.defaults.workspace = cfg.agents.defaults.workspace || '/home/node/clawd';
                  cfg.agents.defaults.model = cfg.agents.defaults.model || {};
                  cfg.agents.defaults.model.primary = displayModel;

                  // Update models
                  cfg.models = cfg.models || {};
                  cfg.models.providers = cfg.models.providers || {};
                  cfg.models.providers.ollama = {
                    baseUrl: ollamaBase,
                    apiKey: ollamaKey,
                    api: 'openai-completions',
                    models: [{
                      id: modelName,
                      name: modelName,
                      reasoning: false,
                      input: ['text'],
                      cost: { input: 0, output: 0, cacheRead: 0, cacheWrite: 0 },
                      contextWindow: 32768,
                      maxTokens: 4096,
                    }],
                  };

                  delete cfg.model;

                  fs.writeFileSync(path, JSON.stringify(cfg, null, 2));
                NODE
                chown 1000:1000 "$CONFIG_PATH"

                AUTH_DIR="/home/node/.openclaw/agents/main/agent"
                mkdir -p "$AUTH_DIR"
                AUTH_FILE="$AUTH_DIR/auth-profiles.json"
                if [ ! -f "$AUTH_FILE" ]; then
                  API_KEY="${OLLAMA_API_KEY:-ollama}"
                  API_BASE="${OLLAMA_BASE:-http://192.168.30.111:11435/v1}"
                  printf '{\n  "ollama": {\n    "api_key": "%s",\n    "api_base": "%s"\n  }\n}\n' "$API_KEY" "$API_BASE" > "$AUTH_FILE"
                fi
                chown -R 1000:1000 "$AUTH_DIR"

                echo "Configuring kubectl with kubeconfig symlink..."
                mkdir -p /home/node/.kube
                if [ -f /home/node/code/cberg-home-nextgen/kubeconfig ]; then
                  ln -sf /home/node/code/cberg-home-nextgen/kubeconfig /home/node/.kube/config
                  echo "Kubeconfig linked from ~/code/cberg-home-nextgen/kubeconfig"
                else
                  echo "Warning: kubeconfig not found at ~/code/cberg-home-nextgen/kubeconfig"
                fi

                echo "=== Debug: config files ==="
                find /home/node/.openclaw -maxdepth 3 -name "*.json" -not -path "*/node_modules/*" 2>/dev/null || true
                echo "=== Debug: openclaw.json gateway section ==="
                node -e "try{const c=JSON.parse(require('fs').readFileSync('/home/node/.openclaw/openclaw.json','utf8'));console.log(JSON.stringify(c.gateway,null,2))}catch(e){console.log('no openclaw.json:',e.message)}" 2>/dev/null || true
                echo "=== Debug: env vars ==="
                env | grep -i 'OPENCLAW\|CLAWDBOT\|gateway\|token' || true
                echo "=== Debug: openclaw config show ==="
                /home/node/.openclaw/bin/openclaw config show 2>&1 | head -30 || true

                echo "Starting OpenClaw Gateway..."
                mkdir -p /home/node/clawd
                cd /home/node/clawd
                exec /home/node/.openclaw/bin/openclaw gateway --port 18789 --verbose

            env:
              - name: PATH
                value: "/home/node/.local/share/mise/shims:/home/node/.openclaw/bin:/home/node/.local/bin:/home/node/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
              # Node configuration
              - name: NODE_ENV
                value: "production"

              # Gateway port
              - name: GATEWAY_PORT
                value: "18789"
              - name: OLLAMA_BASE
                value: "http://192.168.30.111:11435/v1"
              - name: OLLAMA_MODEL
                value: "gpt-oss:20b"
              - name: OLLAMA_API_KEY
                value: "ollama"
              # GitHub token for mise and git operations
              - name: GITHUB_TOKEN
                valueFrom:
                  secretKeyRef:
                    name: openclaw-secret
                    key: GITHUB_TOKEN
            envFrom:
              - secretRef:
                  name: openclaw-secret

            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  tcpSocket:
                    port: 18789
                  initialDelaySeconds: 60
                  periodSeconds: 30
                  timeoutSeconds: 5
                  failureThreshold: 3

              readiness:
                enabled: true
                custom: true
                spec:
                  tcpSocket:
                    port: 18789
                  initialDelaySeconds: 10
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 3

              startup:
                enabled: true
                custom: true
                spec:
                  tcpSocket:
                    port: 18789
                  initialDelaySeconds: 10
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 30

            resources:
              requests:
                cpu: 100m
                memory: 512Mi
              limits:
                cpu: 2
                memory: 2Gi

            securityContext:
              runAsNonRoot: true
              runAsUser: 1000
              runAsGroup: 1000
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
              capabilities:
                drop:
                  - ALL

    service:
      main:
        controller: openclaw
        type: ClusterIP
        ports:
          http:
            protocol: TCP
            port: 18789
            targetPort: 18789

    ingress:
      main:
        enabled: true
        className: internal
        annotations:
          gethomepage.dev/enabled: "true"
          gethomepage.dev/name: "OpenClaw"
          gethomepage.dev/group: "AI"
          gethomepage.dev/icon: "telegram.png"
          gethomepage.dev/description: "Telegram AI Assistant - OpenClaw Gateway"
        labels:
          gethomepage.dev/enabled: "true"
        hosts:
          - host: openclaw.${SECRET_DOMAIN}
            paths:
              - path: /
                pathType: Prefix
                service:
                  identifier: main
                  port: http
        tls:
          - hosts:
              - openclaw.${SECRET_DOMAIN}

    persistence:
      config:
        type: persistentVolumeClaim
        existingClaim: openclaw-data
        advancedMounts:
          openclaw:
            app:
              - path: /home/node
            install-openclaw:
              - path: /home/node

      npm-cache:
        type: emptyDir
        sizeLimit: 2Gi
        advancedMounts:
          openclaw:
            install-openclaw:
              - path: /home/node/.npm

      tmp:
        type: emptyDir
        advancedMounts:
          openclaw:
            app:
              - path: /tmp
