---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: k8s-ai-controller
  namespace: ai
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: k8s-ai-controller
rules:
  # Core resources - full access
  - apiGroups: [""]
    resources:
      - pods
      - services
      - endpoints
      - persistentvolumeclaims
      - persistentvolumes
      - nodes
      - namespaces
      - configmaps
      - secrets
      - serviceaccounts
      - events
      - replicationcontrollers
      - limitranges
      - resourcequotas
    verbs: ["*"]
  # Core resource status and logs
  - apiGroups: [""]
    resources:
      - pods/status
      - pods/log
      - pods/exec
      - pods/portforward
      - services/status
      - nodes/status
      - persistentvolumeclaims/status
      - persistentvolumes/status
    verbs: ["*"]
  # Apps resources - full access
  - apiGroups: ["apps"]
    resources:
      - deployments
      - daemonsets
      - replicasets
      - statefulsets
    verbs: ["*"]
  # Apps status subresources
  - apiGroups: ["apps"]
    resources:
      - deployments/status
      - deployments/scale
      - daemonsets/status
      - replicasets/status
      - replicasets/scale
      - statefulsets/status
      - statefulsets/scale
    verbs: ["*"]
  # Batch resources - full access
  - apiGroups: ["batch"]
    resources:
      - jobs
      - cronjobs
    verbs: ["*"]
  # Batch status subresources
  - apiGroups: ["batch"]
    resources:
      - jobs/status
      - cronjobs/status
    verbs: ["*"]
  # Networking resources - full access
  - apiGroups: ["networking.k8s.io"]
    resources:
      - ingresses
      - networkpolicies
      - ingressclasses
    verbs: ["*"]
  # RBAC resources - full access
  - apiGroups: ["rbac.authorization.k8s.io"]
    resources:
      - roles
      - rolebindings
      - clusterroles
      - clusterrolebindings
    verbs: ["*"]
  # Storage resources - full access
  - apiGroups: ["storage.k8s.io"]
    resources:
      - storageclasses
      - volumeattachments
      - csidrivers
      - csinodes
    verbs: ["*"]
  # Flux Helm resources - full access
  - apiGroups: ["helm.toolkit.fluxcd.io"]
    resources:
      - helmreleases
    verbs: ["*"]
  # Flux Kustomize resources - full access
  - apiGroups: ["kustomize.toolkit.fluxcd.io"]
    resources:
      - kustomizations
    verbs: ["*"]
  # Flux Source resources - full access
  - apiGroups: ["source.toolkit.fluxcd.io"]
    resources:
      - gitrepositories
      - helmrepositories
      - helmcharts
      - buckets
      - ocirepositories
    verbs: ["*"]
  # Autoscaling resources - full access
  - apiGroups: ["autoscaling"]
    resources:
      - horizontalpodautoscalers
    verbs: ["*"]
  # Policy resources - full access
  - apiGroups: ["policy"]
    resources:
      - poddisruptionbudgets
      - podsecuritypolicies
    verbs: ["*"]
  # CRDs - full access
  - apiGroups: ["apiextensions.k8s.io"]
    resources:
      - customresourcedefinitions
    verbs: ["*"]
  # Metrics - read access
  - apiGroups: ["metrics.k8s.io"]
    resources:
      - pods
      - nodes
    verbs: ["get", "list"]
  # Cert-manager resources (if installed)
  - apiGroups: ["cert-manager.io"]
    resources:
      - certificates
      - certificaterequests
      - issuers
      - clusterissuers
    verbs: ["*"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: k8s-ai-controller
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: k8s-ai-controller
subjects:
  - kind: ServiceAccount
    name: k8s-ai-controller
    namespace: ai
