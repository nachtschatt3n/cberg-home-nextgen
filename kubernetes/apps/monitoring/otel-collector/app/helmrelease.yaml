---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: otel-collector
  namespace: monitoring
spec:
  interval: 30m
  chart:
    spec:
      chart: opentelemetry-collector
      version: 0.92.0
      sourceRef:
        kind: HelmRepository
        name: opentelemetry
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    mode: deployment
    replicaCount: 2
    image:
      repository: otel/opentelemetry-collector-contrib
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        memory: 1Gi
    service:
      type: ClusterIP
    extraVolumes:
      - name: apm-certs
        secret:
          secretName: apm-apm-http-certs-public
    extraVolumeMounts:
      - name: apm-certs
        mountPath: /etc/otel/certs
        readOnly: true
    ports:
      otlp:
        enabled: true
        containerPort: 4317
        servicePort: 4317
        hostPort: 4317
        protocol: TCP
      otlp-http:
        enabled: true
        containerPort: 4318
        servicePort: 4318
        hostPort: 4318
        protocol: TCP
      prometheus:
        enabled: true
        containerPort: 9090
        servicePort: 9090
        protocol: TCP
      metrics:
        enabled: true
        containerPort: 8888
        servicePort: 8888
        protocol: TCP
    config:
      receivers:
        otlp:
          protocols:
            grpc:
              endpoint: 0.0.0.0:4317
            http:
              endpoint: 0.0.0.0:4318
        prometheus:
          config:
            scrape_configs:
              - job_name: 'otel-collector'
                scrape_interval: 30s
                static_configs:
                  - targets: ['localhost:8888']
      processors:
        batch: {}
        k8sattributes:
          extract:
            metadata:
              - k8s.namespace.name
              - k8s.pod.name
              - k8s.deployment.name
              - k8s.statefulset.name
              - k8s.node.name
        resource:
          attributes:
            - key: k8s.cluster.name
              value: cberg-home
              action: upsert
      exporters:
        otlphttp/elastic:
          endpoint: https://apm-apm-http.monitoring.svc:8200
          headers:
            Authorization: "Bearer HEoBOZQ5jI0+bedwwffXb0G4rAZpm/w+v7ncaSeSqIk="
          tls:
            insecure_skip_verify: false
            ca_file: /etc/otel/certs/tls.crt
        logging:
          loglevel: info
      service:
        telemetry:
          metrics:
            address: 0.0.0.0:8888
        pipelines:
          traces:
            receivers: [otlp]
            processors: [k8sattributes, batch, resource]
            exporters: [otlphttp/elastic, logging]
          metrics:
            receivers: [otlp, prometheus]
            processors: [k8sattributes, batch, resource]
            exporters: [otlphttp/elastic]
          logs:
            receivers: [otlp]
            processors: [k8sattributes, batch, resource]
            exporters: [otlphttp/elastic]
