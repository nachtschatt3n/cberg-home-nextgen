---
apiVersion: v1
kind: ConfigMap
metadata:
  name: filebeat-config
data:
  filebeat.yml: |
    filebeat.inputs:
    - type: container
      paths:
        - /var/log/containers/*.log
      processors:
      - add_kubernetes_metadata:
          host: ${NODE_NAME}
          matchers:
          - logs_path:
              logs_path: "/var/log/containers/"
      - decode_json_fields:
          fields: ["message"]
          target: ""
          overwrite_keys: true

    output.elasticsearch:
      hosts: ["https://elasticsearch-es-http.monitoring.svc:9200"]
      username: "elastic"
      password: "MC3lY6PQ2lkhP2z70Q1pw373"
      ssl.certificate_authorities: ["/usr/share/filebeat/config/certs/tls.crt"]
      index: "filebeat-%{[agent.version]}-%{+yyyy.MM.dd}"

    setup.ilm.enabled: false
    setup.template.enabled: true
    setup.template.overwrite: true
    setup.template.name: "filebeat"
    setup.template.pattern: "filebeat-*"
    setup.template.settings:
      index.number_of_shards: 1
      index.number_of_replicas: 1
    setup.template.json.enabled: false

    logging.level: info
    logging.to_stderr: true

    http.enabled: true
    http.host: "0.0.0.0"
    http.port: 5066
