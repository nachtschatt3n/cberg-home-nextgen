---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: metricbeat
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.6.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    controllers:
      metricbeat:
        replicas: 2
        initContainers:
          config-template:
            image:
              repository: alpine
              tag: latest
            command:
              - sh
              - -c
              - |
                apk add --no-cache gettext
                export ELASTICSEARCH_USERNAME ELASTICSEARCH_PASSWORD
                envsubst < /tmp/config-template/metricbeat.yml > /tmp/config-final/metricbeat.yml
        containers:
          app:
            image:
              repository: docker.elastic.co/beats/metricbeat
              tag: 8.15.3
            args:
              - "-c"
              - "/tmp/config-final/metricbeat.yml"
              - "-e"
            env:
              - name: ELASTICSEARCH_USERNAME
                valueFrom:
                  secretKeyRef:
                    name: metricbeat-es-credentials
                    key: username
              - name: ELASTICSEARCH_PASSWORD
                valueFrom:
                  secretKeyRef:
                    name: metricbeat-es-credentials
                    key: password
            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  exec:
                    command:
                      - sh
                      - -c
                      - |
                        #!/usr/bin/env bash -e
                        curl --fail 127.0.0.1:5066
                  initialDelaySeconds: 60
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 3
              readiness:
                enabled: true
                custom: true
                spec:
                  exec:
                    command:
                      - sh
                      - -c
                      - |
                        #!/usr/bin/env bash -e
                        metricbeat test output
                  initialDelaySeconds: 60
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 3
            securityContext:
              runAsUser: 0
              runAsNonRoot: false
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                cpu: 500m
                memory: 512Mi
    
    service:
      main:
        controller: metricbeat
        enabled: false
    
    persistence:
      config-template:
        type: configMap
        name: metricbeat-config
        advancedMounts:
          metricbeat:
            config-template:
              - path: /tmp/config-template/metricbeat.yml
                subPath: metricbeat.yml
                readOnly: true
      config-final:
        type: emptyDir
        globalMounts:
          - path: /tmp/config-final
      elasticsearch-certs:
        type: secret
        name: elasticsearch-es-http-certs-public
        globalMounts:
          - path: /usr/share/metricbeat/config/certs
            readOnly: true
