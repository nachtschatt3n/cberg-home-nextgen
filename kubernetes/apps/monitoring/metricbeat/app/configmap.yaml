---
apiVersion: v1
kind: ConfigMap
metadata:
  name: metricbeat-config
data:
  metricbeat.yml: |
    metricbeat.modules:
    - module: prometheus
      period: 30s
      hosts: ["kube-prometheus-stack-prometheus.monitoring.svc:9090"]
      metrics_path: /metrics
      metricsets: ["collector"]
      
    - module: prometheus
      period: 30s
      hosts: ["kube-prometheus-stack-prometheus.monitoring.svc:9090"]
      metrics_path: /federate
      metricsets: ["query"]
      query:
        match[]:
          - '{__name__=~"up|process_.*|go_.*|container_.*|node_.*|kube_.*|prometheus_.*|alertmanager_.*"}'
    
    output.elasticsearch:
      hosts: ["https://elasticsearch-es-http.monitoring.svc:9200"]
      username: "elastic"
      password: "MC3lY6PQ2lkhP2z70Q1pw373"
      ssl.certificate_authorities: ["/usr/share/metricbeat/config/certs/tls.crt"]
      index: "metricbeat-%{[agent.version]}-%{+yyyy.MM.dd}"
      allow_older_versions: true

    setup.ilm.enabled: false
    setup.template.enabled: true
    setup.template.overwrite: true
    setup.template.name: "metricbeat"
    setup.template.pattern: "metricbeat-*"
    setup.template.settings:
      index.number_of_shards: 1
      index.number_of_replicas: 1
    setup.template.json.enabled: false
    
    processors:
      - add_cloud_metadata: ~
      - add_kubernetes_metadata: ~
    
    http.enabled: true
    http.host: "0.0.0.0"
    http.port: 5066
    
    logging.level: info
    logging.to_stderr: true
    logging.event_data.to_stderr: true
    logging.event_data.to_files: false
