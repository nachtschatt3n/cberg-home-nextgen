---
apiVersion: v1
kind: ConfigMap
metadata:
  name: metricbeat-config
data:
  metricbeat.yml: |
    metricbeat.modules:
    - module: prometheus
      period: 30s
      hosts: ["kube-prometheus-stack-prometheus.monitoring.svc:9090"]
      metrics_path: /metrics
      metricsets: ["collector"]
      
    - module: prometheus
      period: 30s
      hosts: ["kube-prometheus-stack-prometheus.monitoring.svc:9090"]
      metrics_path: /federate
      metricsets: ["query"]
      query:
        match[]:
          - '{__name__=~"up|process_.*|go_.*|container_.*|node_.*|kube_.*|prometheus_.*|alertmanager_.*"}'
    
    output.elasticsearch:
      hosts: ["https://elasticsearch-es-http.monitoring.svc:9200"]
      username: "${ELASTICSEARCH_USERNAME}"
      password: "${ELASTICSEARCH_PASSWORD}"
      ssl.certificate_authorities: ["/usr/share/metricbeat/config/certs/tls.crt"]
      index: "metrics-prometheus-%{+yyyy.MM.dd}"
    
    setup.ilm.enabled: true
    setup.ilm.policy_name: "metrics-default"
    setup.ilm.rollover_alias: "metrics-prometheus"
    setup.ilm.pattern: "{now/d}-000001"
    
    setup.template.name: "metrics-prometheus"
    setup.template.pattern: "metrics-prometheus-*"
    
    processors:
      - add_cloud_metadata: ~
      - add_kubernetes_metadata: ~
    
    http.enabled: true
    http.host: "0.0.0.0"
    http.port: 5066
    
    logging.level: info
    logging.to_stderr: true
