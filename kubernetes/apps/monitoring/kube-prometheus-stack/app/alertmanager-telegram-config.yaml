apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: telegram
  namespace: monitoring
  labels:
    alertmanager-config: telegram
spec:
  route:
    receiver: telegram
    groupBy:
      - alertname
    groupWait: 0s
    groupInterval: 1s
    repeatInterval: 120s
  receivers:
    - name: telegram
      telegramConfigs:
        - botToken:
            name: alertmanager-telegram-secret
            key: bot-token
          chatID: 671676995  # numeric chat ID (must be an integer)
          parseMode: HTML  # use HTML parsing to avoid escaping issues
          sendResolved: true
          message: |
            Alert: {{ .CommonLabels.alertname }}
            Severity: {{ .CommonLabels.severity }}
            Instance: {{ .CommonLabels.instance }}
            Summary: {{ .CommonAnnotations.summary }}

          # message: |
          #   {{ define "alert_list" }}{{ range . }}
          #   ---
          #   🪪 <b>{{ .Labels.alertname }}</b>
          #   {{- if eq .Labels.severity "critical" }}
          #   🚨 CRITICAL 🚨 {{ end }}
          #   {{- if eq .Labels.severity "warning" }}
          #   ⚠️ WARNING ⚠️{{ end }}
          #   {{- if .Annotations.summary }}
          #   📝 {{ .Annotations.summary }}{{ end }}
          #   {{- if .Annotations.description }}
          #   📖 {{ .Annotations.description }}{{ end }}

          #   🏷 Labels:
          #   {{ range .Labels.SortedPairs }}  <i>{{ .Name }}</i>: <code>{{ .Value }}</code>
          #   {{ end }}{{ end }}
          #   🛠 <a href="https://grafana.uhl.cool">Grafana</a> 💊 <a href="https://alertmanager.uhl.cool">Alertmanager</a> 💊 <a href="https://">Any other link</a> 🛠
          #   {{ end }}

          #   {{ define "telegram.message" }}
          #   {{ if gt (len .Alerts.Firing) 0 }}
          #   🔥 Alerts Firing 🔥
          #   {{ template "alert_list" .Alerts.Firing }}
          #   {{ end }}
          #   {{ if gt (len .Alerts.Resolved) 0 }}
          #   ✅ Alerts Resolved ✅
          #   {{ template "alert_list" .Alerts.Resolved }}
          #   {{ end }}
          #   {{ end }}
