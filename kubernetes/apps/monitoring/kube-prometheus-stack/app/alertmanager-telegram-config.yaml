apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: telegram
  namespace: monitoring
  labels:
    alertmanager-config: telegram
spec:
  route:
    receiver: telegram
    groupBy:
      - alertname
    groupWait: 1s
    groupInterval: 1s
    repeatInterval: 120s
    # Match all alerts from any namespace by not specifying namespace matchers
    matchers: []
    routes:
      # Suppress Watchdog alerts (always firing, not useful for notifications)
      - receiver: "null"
        matchers:
          - name: alertname
            value: Watchdog
  receivers:
    # Null receiver for suppressed alerts (like Watchdog)
    - name: "null"
    - name: telegram
      telegramConfigs:
        - botToken:
            name: alertmanager-telegram-secret
            key: bot-token
          chatID: 671676995  # numeric chat ID (must be an integer)
          parseMode: HTML  # use HTML parsing to avoid escaping issues
          sendResolved: true
          message: |
            üö® <b>{{ .CommonLabels.alertname }}</b>
            Severity: {{ .CommonLabels.severity | toUpper }}
            {{ if .CommonLabels.component }}Component: {{ .CommonLabels.component }}{{ end }}
            {{ if .CommonLabels.node }}Node: {{ .CommonLabels.node }}{{ else if .CommonLabels.instance }}Instance: {{ .CommonLabels.instance }}{{ end }}
            
            {{ range .Alerts }}
            ‚Ä¢ <b>{{ .Annotations.summary | default .Labels.alertname }}</b>
            {{ if .Labels.node }}  üñ• Node: {{ .Labels.node }}{{ end }}
            {{ if .Labels.volume }}  üíæ Volume: {{ .Labels.volume }}{{ end }}
            {{ if .Labels.pvc }}  üìã PVC: {{ .Labels.pvc }}{{ end }}
            {{ if .Labels.pvc_namespace }}  üíº Namespace: {{ .Labels.pvc_namespace }}{{ end }}
            {{ if .Annotations.description }}  üìù {{ .Annotations.description }}{{ end }}
            {{ end }}
