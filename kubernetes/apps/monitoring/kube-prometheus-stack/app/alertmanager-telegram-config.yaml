apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: telegram
  namespace: monitoring
  labels:
    alertmanager-config: telegram
spec:
  route:
    receiver: telegram
    groupBy:
      - alertname
    groupWait: 0s
    groupInterval: 1s
    repeatInterval: 1s
  receivers:
    - name: telegram
      telegramConfigs:
        - botToken:
            name: alertmanager-telegram-secret
            key: bot-token
          chatID: 671676995  # numeric chat ID (must be an integer)
          parseMode: HTML  # use HTML parsing to avoid escaping issues
          sendResolved: true
          message: |
            {{ define "alert_list" }}{{ range . }}
            ---
            ğŸªª <b>{{ .Labels.alertname }}</b>
            {{- if eq .Labels.severity "critical" }}
            ğŸš¨ CRITICAL ğŸš¨ {{ end }}
            {{- if eq .Labels.severity "warning" }}
            âš ï¸ WARNING âš ï¸{{ end }}
            {{- if .Annotations.summary }}
            ğŸ“ {{ .Annotations.summary }}{{ end }}
            {{- if .Annotations.description }}
            ğŸ“– {{ .Annotations.description }}{{ end }}

            ğŸ· Labels:
            {{ range .Labels.SortedPairs }}  <i>{{ .Name }}</i>: <code>{{ .Value }}</code>
            {{ end }}{{ end }}
            ğŸ›  <a href="https://grafana.example.com">Grafana</a> ğŸ’Š <a href="https://alertmanager.example.com">Alertmanager</a> ğŸ’Š <a href="https://">Any other link</a> ğŸ› 
            {{ end }}

            {{ define "telegram.message" }}
            {{ if gt (len .Alerts.Firing) 0 }}
            ğŸ”¥ Alerts Firing ğŸ”¥
            {{ template "alert_list" .Alerts.Firing }}
            {{ end }}
            {{ if gt (len .Alerts.Resolved) 0 }}
            âœ… Alerts Resolved âœ…
            {{ template "alert_list" .Alerts.Resolved }}
            {{ end }}
            {{ end }}





          # message: |
          #   Alert: {{ .CommonLabels.alertname }}
          #   Severity: {{ .CommonLabels.severity }}
          #   Instance: {{ .CommonLabels.instance }}
          #   Summary: {{ .CommonAnnotations.summary }}
      # templates:
      # - '../message_templates/telegram.tmpl' # path to our telegram.tmpl
      # templates provided via alertmanager.templateFiles in Helm values