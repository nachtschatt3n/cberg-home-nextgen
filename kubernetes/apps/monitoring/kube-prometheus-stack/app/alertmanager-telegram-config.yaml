apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: telegram
  namespace: monitoring
  labels:
    alertmanager-config: telegram
spec:
  route:
    receiver: telegram
    groupBy:
      - alertname
    groupWait: 1s
    groupInterval: 1s
    repeatInterval: 120s
    # Match all alerts from any namespace by not specifying namespace matchers
    matchers: []
    routes:
      # Suppress Watchdog alerts (always firing, not useful for notifications)
      - receiver: "null"
        matchers:
          - name: alertname
            value: Watchdog
      # Low-impact warning alerts - once per day
      - receiver: telegram
        matchers:
          - name: severity
            value: warning
          - name: category
            value: storage
        groupWait: 1s
        groupInterval: 86400s  # 24 hours - prevent frequent updates
        repeatInterval: 86400s  # 24 hours
        continue: false
  receivers:
    # Null receiver for suppressed alerts (like Watchdog)
    - name: "null"
    - name: telegram
      telegramConfigs:
        - botToken:
            name: alertmanager-telegram-secret
            key: bot-token
          chatID: 671676995  # numeric chat ID (must be an integer)
          parseMode: HTML  # use HTML parsing to avoid escaping issues
          sendResolved: true
          message: |
            üö® <b>{{ .CommonLabels.alertname }}</b> ({{ len .Alerts }} alerts)
            Severity: {{ .CommonLabels.severity | toUpper }}
            {{- if .CommonLabels.component }} | Component: {{ .CommonLabels.component }}{{- end }}
            {{- if .CommonLabels.node }} | Node: {{ .CommonLabels.node }}{{- end }}
            
            {{- if gt (len .Alerts) 10 }}
            ‚ö†Ô∏è Showing first 10 of {{ len .Alerts }} alerts:
            {{- end }}
            {{- range $i, $alert := .Alerts }}
            {{- if lt $i 10 }}
            ‚Ä¢ {{- if $alert.Annotations.summary }} {{ $alert.Annotations.summary }}{{- else }} {{ $alert.Labels.alertname }}{{- end }}
            {{- if $alert.Labels.node }} [{{ $alert.Labels.node }}]{{- end }}
            {{- end }}
            {{- end }}
            {{- if gt (len .Alerts) 10 }}
            
            ... and more alerts ({{ len .Alerts }} total)
            {{- end }}
