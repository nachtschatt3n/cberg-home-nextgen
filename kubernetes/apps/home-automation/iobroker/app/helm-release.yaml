---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: iobroker
  namespace: home-automation
spec:
  interval: 15m
  timeout: 20m
  chart:
    spec:
      chart: app-template
      version: 2.4.0
      interval: 15m
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  install:
    remediation:
      retries: 1
  upgrade:
    timeout: 20m
    cleanupOnFail: true
    remediation:
      retries: 1
  values:
    defaultPodOptions:
      hostname: iobroker
    controllers:
      main:
        type: statefulset
        strategy: RollingUpdate
        replicas: 1
        containers:
          main:
            nameOverride: iobroker
            image:
              repository: buanet/iobroker
              tag: v11.1.0
              #tag: v10.0.0
              pullPolicy: IfNotPresent

            # -- environment variables.
            # See [image docs](https://docs.buanet.de/iobroker-docker-image/docs/) for more details.
            env:
              - name: AVAHI
                value: "false"
              #- name: DEBUG
              #  value: "false"
              # - name: IOB_ADMINPORT
              #   value: "8081"
              - name: IOB_BACKITUP_EXTDB
                value: "true"
              # - name: IOB_MULTIHOST
              #   value: "none"
              # - name: IOB_OBJECTSDB_HOST
              #   value: "127.0.0.1"
              # - name: IOB_OBJECTSDB_PORT
              #   value: "9001"
              # - name: IOB_OBJECTSDB_TYPE
              #   value: "jsonl" / "file" / "redis"
              # - name: IOB_STATESDB_HOST
              #   value: "127.0.0.1"
              # - name: IOB_STATESDB_PORT
              #   value: "9000"
              # - name: IOB_STATESDB_TYPE
              #   value: "jsonl" / "file" / "redis"
              - name: LANG
                value: "de_DE.UTF-8"
              - name: LANGUAGE
                value: "de_DE.UTF-8"
              - name: LC_ALL
                value: "de_DE.UTF-8"
              - name: PACKAGES
                value: "influxdb2-cli"
                #value: "default-mysql-client influxdb2-cli redis-tools"
              - name: PERMISSION_CHECK
                value: "true"
              # - name: SETGID
              #  value: "1000"
              # - name: SETUID
              #  value: "1000"
              - name: TZ
                value: "Europe/Berlin"
              # - name: USBDEVICES
              #  value: "/dev/ttyACM0"
              # - name: ZWAVE
              #  value: "false"

            probes:
              # Check controller health without depending on admin UI port (can be disabled)
              liveness:
                enabled: true
                custom: true
                spec:
                  exec:
                    command:
                      - sh
                      - -c
                      - iobroker status | grep -q "is running"
                  initialDelaySeconds: 60
                  periodSeconds: 30
                  timeoutSeconds: 5
                  failureThreshold: 3

              readiness:
                enabled: true
                custom: true
                spec:
                  exec:
                    command:
                      - sh
                      - -c
                      - iobroker status | grep -q "is running"
                  initialDelaySeconds: 30
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 3

              startup:
                enabled: true
                custom: true
                spec:
                  exec:
                    command:
                      - sh
                      - -c
                      - iobroker status | grep -q "is running"
                  initialDelaySeconds: 0
                  periodSeconds: 15
                  timeoutSeconds: 5
                  failureThreshold: 60
    service:
      main:
        controller: main
        type: LoadBalancer
        ports:
          http:
            enabled: true
            port: 8081
          vis:
            enabled: true
            port: 8082
          iobrokerapi:
            enabled: true
            port: 8087
          lovelace:
            enabled: true
            port: 8091
          nodered:
            enabled: true
            port: 1880
          states:
            enabled: true
            port: 9000
          objects:
            enabled: true
            port: 9001
          mqtt:
            protocol: TCP
            enabled: true
            port: 1883
          # mqttws:
          #   protocol: TCP
          #   enabled: true
          #   port: 1884
          # mqttshelly:
          #   protocol: TCP
          #   enabled: true
          #   port: 1885
          nuki:
            protocol: TCP
            enabled: true
            port: 51989
          alexa2-proxy:
            protocol: TCP
            enabled: true
            port: 51988
          avahi:
            protocol: TCP
            enabled: true
            port: 53388
    ingress:
      main:
        enabled: true
        className: "external"
        annotations:
          gethomepage.dev/enabled: "true"
          gethomepage.dev/name: "IoBroker"
          gethomepage.dev/description: "IoBroker is an open-source home automation platform"
          gethomepage.dev/group: "Home Automation"
          gethomepage.dev/icon: "iobroker.png"
          external-dns.alpha.kubernetes.io/target: "external.${SECRET_DOMAIN}"
        labels:
          gethomepage.dev/enabled: "true"
        hosts:
          - host: "iobroker.${SECRET_DOMAIN}"
            paths:
              - path: /
                pathType: Prefix
                service:
                  name: main
                  port: http
              - path: /nodered
                pathType: Prefix
                service:
                  name: main
                  port: nodered
              - path: /vis
                pathType: Prefix
                service:
                  name: main
                  port: vis
              # - host: "nodered.${SECRET_DOMAIN}"
              #   paths:
              #     - path: /
              #       pathType: Prefix
              #       service:
              #         name: main
              #         port: nodered
              # - host: "vis.${SECRET_DOMAIN}"
              #   paths:
              #     - path: /
              #       pathType: Prefix
              #       service:
              #         name: main
              #         port: vis
              # - host: "apiiobroker.${SECRET_DOMAIN}"
              #   paths:
              #     - path: /
              #       pathType: Prefix
              #       service:
              #         name: main
              #         port: iobrokerapi
              # - host: "lovelace.${SECRET_DOMAIN}"
              #   paths:
              #     - path: /
              #       pathType: Prefix
              #       service:
              #         name: main
              #         port: lovelace
        tls:
          - hosts:
              - "iobroker.${SECRET_DOMAIN}"
            # - "nodered.${SECRET_DOMAIN}"
            # - "vis.${SECRET_DOMAIN}"
            # - "iobrokerapi.${SECRET_DOMAIN}"
            # - "lovelace.${SECRET_DOMAIN}"
    persistence:
      config-replicated:
        enabled: true
        existingClaim: iobroker-config
        globalMounts:
          - path: /opt/iobroker
            readOnly: false
    resources:
      requests:
        cpu: 250m
        memory: 2Gi
      limits:
        memory: 4Gi
    securityContext:
      capabilities:
        add:
          - SYS_ADMIN
          - DAC_READ_SEARCH
