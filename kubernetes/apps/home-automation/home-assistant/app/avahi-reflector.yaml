---
apiVersion: v1
kind: ConfigMap
metadata:
  name: avahi-reflector-config
  namespace: home-automation
data:
  avahi-daemon.conf: |
    [server]
    host-name=k8s-mdns-reflector
    domain-name=local
    browse-domains=local
    use-ipv4=yes
    use-ipv6=yes
    allow-interfaces=eth0,cilium_host
    deny-interfaces=lo
    ratelimit-interval-usec=1000000
    ratelimit-burst=1000
    enable-reflector=yes
    enable-dbus=no
    disallow-other-stacks=no

    [wide-area]
    enable-wide-area=no

    [publish]
    disable-publishing=yes
    disable-user-service-publishing=yes
    publish-addresses=no
    publish-hinfo=no
    publish-workstation=no
    publish-domain=no

    [reflector]
    enable-reflector=yes
    reflect-ipv=yes

    [rlimits]
    rlimit-core=0
    rlimit-data=4194304
    rlimit-fsize=0
    rlimit-nofile=768
    rlimit-stack=4194304
    rlimit-nproc=3
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: avahi-reflector
  namespace: home-automation
  labels:
    app.kubernetes.io/name: avahi-reflector
    app.kubernetes.io/component: mdns
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: avahi-reflector
  template:
    metadata:
      labels:
        app.kubernetes.io/name: avahi-reflector
    spec:
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      containers:
      - name: avahi
        image: alpine:3.19
        imagePullPolicy: IfNotPresent
        command:
        - /bin/sh
        - -c
        - |
          apk add --no-cache avahi avahi-tools dbus
          mkdir -p /run/dbus /var/run/avahi-daemon
          dbus-daemon --system --fork
          exec avahi-daemon --no-drop-root --no-chroot --debug
        securityContext:
          privileged: true
          capabilities:
            add:
            - NET_ADMIN
            - NET_RAW
        env:
        - name: TZ
          value: "Europe/Berlin"
        volumeMounts:
        - name: config
          mountPath: /etc/avahi/avahi-daemon.conf
          subPath: avahi-daemon.conf
        resources:
          requests:
            cpu: 10m
            memory: 32Mi
          limits:
            memory: 128Mi
      volumes:
      - name: config
        configMap:
          name: avahi-reflector-config
      tolerations:
      - effect: NoSchedule
        operator: Exists

