---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./secret.sops.yaml
  - ./configmap.sops.yaml
  - ./helmrelease.yaml
  - ./metrics-service.yaml
  - ./prometheusrule.yaml
  - ./cronjob-channels-cleanup.yaml

# Authentik blueprints are stored in SOPS-encrypted configmap.sops.yaml
# This provides security for sensitive domain information in a public repository
# The ConfigMap is the source of truth - what Authentik loads at runtime
# To update blueprints:
# 1. Decrypt: sops -d kubernetes/apps/kube-system/authentik/app/configmap.sops.yaml > /tmp/configmap.yaml
# 2. Edit the blueprint entry in /tmp/configmap.yaml
# 3. Re-encrypt: sops -e /tmp/configmap.yaml > kubernetes/apps/kube-system/authentik/app/configmap.sops.yaml
# 4. Commit and push - Flux will decrypt and apply automatically

# Note: Blueprints are loaded via init containers in helmrelease.yaml:
# - ConfigMap (authentik-blueprints) is mounted as a volume (blueprints-source)
# - Init containers copy all blueprints from blueprints-source to /blueprints (emptyDir volume)
# - Authentik server/worker containers mount /blueprints as read-only
# Volume mounts are configured via extraVolumes/extraVolumeMounts in helmrelease.yaml