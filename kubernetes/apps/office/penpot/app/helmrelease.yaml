---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2beta2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: penpot
  namespace: office
spec:
  interval: 30m
  chart:
    spec:
      chart: penpot
      version: 0.35.0
      sourceRef:
        kind: HelmRepository
        name: penpot
        namespace: flux-system
  maxHistory: 1
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  postRenderers:
    - kustomize:
        patches:
          - target:
              kind: Ingress
              name: penpot
            patch: |
              - op: add
                path: /metadata/labels/gethomepage.dev~1enabled
                value: "true"
  values:
    # Global configuration
    global:
      publicUri: "https://penpot.${SECRET_DOMAIN}"

      # Feature flags
      flags: "disable-registration enable-login-with-password disable-email-verification"

      # Secret key for session encryption
      secretKey:
        valueFrom:
          secretKeyRef:
            name: penpot-secret
            key: PENPOT_SECRET_KEY

      # PostgreSQL configuration
      postgresqlEnabled: true
      postgresql:
        host: ""  # Use dependency
        port: 5432
        username: penpot
        database: penpot

      # Valkey (Redis alternative) configuration
      valkeyEnabled: true
      valkey:
        host: ""  # Use dependency
        port: 6379
        database: 0

    # Application configuration
    config:
      postgresql:
        existingSecret: penpot-secret
        secretKeys:
          passwordKey: PENPOT_POSTGRESQL_PASSWORD

    # Backend service configuration
    backend:
      replicaCount: 1
      service:
        type: ClusterIP
        port: 6060
      resources:
        requests:
          cpu: 500m
          memory: 1Gi
        limits:
          cpu: 2000m
          memory: 2Gi

    # Frontend service configuration
    frontend:
      replicaCount: 1
      service:
        type: ClusterIP
        port: 8080
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi

    # Exporter service configuration
    exporter:
      replicaCount: 1
      service:
        type: ClusterIP
        port: 6061
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi

    # Persistence for assets
    persistence:
      assets:
        enabled: true
        existingClaim: penpot-assets
        size: 20Gi

    # PostgreSQL subchart configuration
    postgresql:
      enabled: true
      auth:
        username: penpot
        existingSecret: penpot-secret
        secretKeys:
          adminPasswordKey: PENPOT_POSTGRESQL_PASSWORD
          userPasswordKey: PENPOT_POSTGRESQL_PASSWORD
        database: penpot
      primary:
        persistence:
          enabled: true
          existingClaim: penpot-postgresql
          size: 10Gi
        resources:
          requests:
            cpu: 250m
            memory: 512Mi
          limits:
            cpu: 1000m
            memory: 1Gi

    # Valkey subchart configuration
    valkey:
      enabled: true
      master:
        persistence:
          enabled: false  # Cache only - no persistence needed
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 256Mi
      replica:
        enabled: false
        replicaCount: 0

    # Ingress configuration
    ingress:
      enabled: true
      className: external
      annotations:
        external-dns.alpha.kubernetes.io/target: external.${SECRET_DOMAIN}
        gethomepage.dev/enabled: "true"
        gethomepage.dev/name: "Penpot"
        gethomepage.dev/description: "Open-source design and prototyping platform"
        gethomepage.dev/group: "Office"
        gethomepage.dev/icon: "penpot.png"
        gethomepage.dev/pod-selector: "app.kubernetes.io/instance=penpot,app.kubernetes.io/name=penpot-backend"
      hosts:
        - penpot.${SECRET_DOMAIN}
      tls:
        - secretName: penpot-tls
          hosts:
            - penpot.${SECRET_DOMAIN}
