# Security Audit â€” 2026-02-28 19:50 UTC

> Auto-generated by security-check.md â€” do not hand-edit. Sensitive values redacted as [DOMAIN], [NAME], [EMAIL].

---

## 1. SOPS Encryption Coverage

**Status: ğŸ”´ Critical**

### Unencrypted `kind: Secret` manifests

| File | Finding |
|------|---------|
| `kubernetes/apps/ai/langfuse/app/clickhouse.yaml` | ğŸ”´ **Plaintext** `password: clickhouse123` in Secret |
| `kubernetes/apps/ai/langfuse/app/postgresql.yaml` | ğŸ”´ **Plaintext** `POSTGRES_PASSWORD: langfuse123` + full DATABASE_URL with password |
| `kubernetes/apps/databases/mariadb/app/helmrelease.yaml` | ğŸŸ¢ SecretKeyRef reference only, no credentials stored |
| `kubernetes/apps/home-automation/esphome/app/helmrelease.yaml` | ğŸŸ¢ SecretKeyRef reference only, no credentials stored |
| `kubernetes/apps/monitoring/headlamp/app/token-secret.yaml` | ğŸŸ¢ ServiceAccountToken type â€” token auto-generated by K8s, no credentials in manifest |
| `kubernetes/apps/monitoring/unpoller/ks.yaml` | ğŸŸ¢ References a Secret, does not define one |
| `kubernetes/flux/cluster/ks.yaml` | ğŸŸ¢ Kustomization config, references Secret kind in substitution config |

### SOPS editor temp file on disk

```
kubernetes/apps/office/penpot/app/.decrypted~secret.sops.yaml  (282 bytes)
```
ğŸ”´ **Critical** â€” SOPS left a decrypted temp file on disk. May contain live secret values. Delete immediately.

### Suspicious base64 / inline credentials (non-sops files)

| File | Finding |
|------|---------|
| `download/tube-archivist/app/elasticsearch-helmrelease.yaml` | ğŸ”´ **Plaintext Basic Auth** `elastic:P9i4!tijlrf34ojiefwsm.kdsf_` base64-encoded in 3 places (public repo) |
| `default/homepage/app/ingress.yaml` | ğŸŸ¡ X-Proxy-Secret token (Authentik forward-auth shared secret) in plaintext annotation |
| `home-automation/esphome/app/ingress.yaml` | ğŸŸ¡ X-Proxy-Secret token in plaintext annotation |
| `home-automation/frigate-nvr/app/ingress.yaml` | ğŸŸ¡ X-Proxy-Secret token in plaintext annotation |
| `monitoring/kube-prometheus-stack/app/prometheus-ingress.yaml` | ğŸŸ¡ X-Proxy-Secret token in plaintext annotation |
| `monitoring/kube-prometheus-stack/app/alertmanager-ingress.yaml` | ğŸŸ¡ X-Proxy-Secret token in plaintext annotation |
| `storage/longhorn/app/ingress.yaml` | ğŸŸ¡ X-Proxy-Secret token in plaintext annotation |

**Remediation:**
- Convert `langfuse/clickhouse.yaml` and `langfuse/postgresql.yaml` Secret blocks to `.sops.yaml` files
- Convert `tube-archivist` Elasticsearch credential to a SOPS-encrypted Secret + secretKeyRef
- Delete the penpot `.decrypted~` temp file immediately: `rm kubernetes/apps/office/penpot/app/.decrypted~secret.sops.yaml`
- X-Proxy-Secret values: since repo is public, these tokens are exposed â€” consider rotating them via new Authentik outpost deployments

---

## 2. Sensitive Data Exposure Scan

**Status: ğŸŸ¢ OK**

- Domain literal: ğŸŸ¢ Not found in any tracked non-sops file
- Git name ([NAME]): ğŸŸ¢ Not found in any tracked non-sops file
- Git email ([EMAIL]): ğŸŸ¢ Not found in any tracked non-sops file

Domain appears only as `${SECRET_DOMAIN}` Flux substitution placeholder in non-sops files. Actual domain is confined to SOPS-encrypted ConfigMaps and secrets.

---

## 3. Git History Secret Scan

**Status: ğŸŸ¡ Warning**

### History patterns

No plaintext credential patterns found in git history (all password/key references use `secretKeyRef`, `valueFrom`, `$__env{}`, `$__file{}`, or environment variable names â€” no literal values).

**Exception â€” historical temp/plaintext files (now deleted):**

| File | Status |
|------|--------|
| `kubernetes/apps/ai/langfuse/app/s3-credentials.yaml` | Deleted â€” was it encrypted at time of commit? Verify |
| `kubernetes/apps/backup/kopia/app/secret.yaml` | Deleted â€” was it encrypted at time of commit? Verify |
| `kubernetes/apps/databases/pgadmin/app/secret.yaml` | Deleted â€” was it encrypted at time of commit? Verify |
| `kubernetes/apps/ai/bytebot/app/secret.sops.tmp.yaml` | `.sops.tmp` suffix â€” was this ever a plaintext temp file? |
| `kubernetes/flux/meta/repositories/git/github-k8s-self-ai-ops-secret-temp.yaml` | `secret-temp` in name â€” review this commit |

### Domain literal in git history

**7 lines** in non-sops files across deleted content:
- `dev-andreamosteller.[DOMAIN]` and `pro-andreamosteller.[DOMAIN]` â€” in deleted ingress files
- `longhorn.[DOMAIN]`, `auth.[DOMAIN]` â€” in deleted Authentik blueprint files (before SOPS ConfigMap migration)

ğŸŸ¡ **Warning**: Domain appeared in public repo git history before SOPS ConfigMap migration. Domain alone is low-risk but confirms the migration was needed and complete.

**Remediation:**
- Verify the historically deleted `secret.yaml` files were encrypted at commit time (inspect git log for those commits)
- Consider git history scrubbing if plaintext credentials are found in deleted files

---

## 4. CVE / Vulnerability Check

**Status: ğŸŸ¢ OK**

- Renovate security-labeled PRs: **0 open**
- OSV.dev check (25 components): **ğŸŸ¢ No CVEs found**

---

## 5. Authentik Security Log Analysis

**Status: ğŸŸ¢ OK**

- Failed login events (7 days): **0**
- Elasticsearch: green, 1 data node, indices covering 2026-02-24 â†’ 2026-02-28
- No brute force indicators detected

---

## 6. External Service Attack Pattern Analysis

**Status: ğŸŸ¢ OK**

- Attack pattern hits in ingress logs (24h): **0**
  - Path traversal, SQLi, XSS, wp-login, .env, cmd.exe patterns: none found
- 5xx error log lines (24h): **0**

---

## 7. RBAC & Pod Security Audit

**Status: ğŸŸ¡ Warning**

### Wildcard RBAC (non-system ClusterRoles)

Standard Kubernetes built-in roles (`admin`, `edit`, `view`, `cluster-admin`) have wildcard rules â€” this is expected and not actionable. Notable **application-added** wildcard roles:

| Role | Concern |
|------|---------|
| `crd-controller-flux-system` | Flux operator CRD controller â€” expected for GitOps |
| `flux-edit-flux-system` / `flux-view-flux-system` | Flux built-in â€” expected |
| `longhorn-role` | `verbs=['*']` on CRDs, PVs, storageclasses, Longhorn CRs â€” expected for CSI |
| `kube-prometheus-stack-operator` | `verbs=['*']` on monitoring CRDs â€” expected |
| `external-dns` | `verbs=['*']` on `dnsendpoints/status` only â€” narrow, OK |
| `k8s-gateway` | `watch/list` all resources â€” needed for DNS discovery |

ğŸŸ¢ No unexpected application-level wildcard roles found.

### Privileged containers

**Infrastructure (expected):**

| Component | Reason |
|-----------|--------|
| `kube-system/cilium-*` | CNI requires BPF mount and privileged |
| `storage/longhorn-csi-plugin-*`, `instance-manager-*`, `engine-image-*` | Storage CSI requires privileged |
| `kube-system/csi-smb-*` | SMB CSI driver requires privileged |

**Application-level privileged (ğŸŸ¡ verify intent):**

| Pod | Container | Finding |
|-----|-----------|---------|
| `home-automation/frigate-*` | `frigate` | ğŸŸ¡ PRIVILEGED + hostPath(`/dev/dri`) â€” GPU hardware transcoding |
| `home-automation/otbr-*` | `app` | ğŸŸ¡ PRIVILEGED â€” OpenThread Border Router needs raw network |
| `home-automation/scrypted-*` | `app` | ğŸŸ¡ PRIVILEGED + ROOT â€” camera/NVR hardware access |
| `media/jellyfin-*` | `jellyfin` | ğŸŸ¡ PRIVILEGED + ROOT + hostPath(`/dev/dri`) â€” hardware transcoding |
| `media/makemkv-*` | `main` | ğŸŸ¡ PRIVILEGED + ROOT â€” Blu-ray device access |
| `ai/openclaw-*` | `install-openclaw` (init) | ğŸŸ¡ ROOT uid=0 init container |
| `backup/icloud-docker-*` | `app` | ğŸŸ¡ ROOT uid=0 |
| `home-automation/node-red-*` | `app` | ğŸŸ¡ ROOT uid=0 |

All application privileged containers are in home automation/media namespaces and use hardware device access â€” likely all intentional. No unexpected privileged containers in `office`, `databases`, `monitoring`, `kube-system` (non-infra).

### Stale debug pod

```
default/node-debugger-k8s-nuc14-01-24zzs  (created 2026-02-24, Completed)
  hostNetwork=true, hostPID=true, hostPath(/)
```
ğŸŸ¡ **Warning** â€” Completed debug pod with full host access still running. Safe to delete.

**Remediation:**
```bash
kubectl delete pod node-debugger-k8s-nuc14-01-24zzs -n default
```

---

## 8. External Exposure Inventory

**Status: ğŸŸ¡ Warning**

### External ingresses found: 22

**Expected external services (all accounted for):**
`auth`, `drive` (nextcloud), `paperless`, `langfuse`, `kuma`, `flux-webhook`, `music-api`, `music-stream`, `absenty`, `absenty-dev`, `pro-andreamosteller`, `penpot`, `drive` (notify-push), `whiteboard`

**Unexpected / review required:**

| Service | Finding |
|---------|---------|
| `default/echo-server` (`echo-server.[DOMAIN]`) | ğŸŸ¡ Echo server publicly exposed â€” likely a test artifact, should be removed |
| `ai/open-webui` (`open-webui.[DOMAIN]`) | ğŸŸ¡ No Authentik auth annotation â€” AI chat exposed without auth layer |
| `home-automation/iobroker` (`iobroker.[DOMAIN]`) | ğŸŸ¡ No Authentik auth annotation â€” smart home control panel exposed |
| `home-automation/n8n` (`n8n.[DOMAIN]`) | ğŸŸ¡ No Authentik auth annotation â€” workflow automation exposed |
| `download/tube-archivist` (`tube-archivist.[DOMAIN]`) | ğŸŸ¡ No Authentik auth annotation + has hardcoded ES credential |
| `media/jellyfin` (`jellyfin.[DOMAIN]`) | ğŸŸ¡ No Authentik auth â€” relies on Jellyfin's own auth |

**Note:** Langfuse, open-webui, iobroker, n8n, tube-archivist have no `nginx.ingress.kubernetes.io/auth-url` annotation â€” they rely on their own application-level authentication. This is acceptable if their built-in auth is properly configured, but adds risk if those apps have auth vulnerabilities.

### LoadBalancer services (internal k8s network only, 192.168.55.x)

All LB services are on 192.168.55.0/24 (k8s-network VLAN 55) â€” not directly internet-accessible. The external ingress controller (192.168.55.102) fronts all external traffic through Cloudflare Tunnel.

Notable:
- `home-automation/mosquitto-main:1883` â€” unencrypted MQTT, internal VLAN only âœ…
- `media/plex:32400` â€” Plex direct play, internal VLAN only âœ…

---

## 9. Certificate Integrity

**Status: ğŸŸ¢ OK**

### Wildcard TLS certificate (Let's Encrypt)

```
Subject: CN=[DOMAIN]
Issuer:  C=US, O=Let's Encrypt, CN=R12
Valid:   Jan 5 2026 â†’ Apr 5 2026  (35 days remaining)
```

ğŸŸ¢ Valid, Let's Encrypt CA, 35 days remaining â€” within normal range (auto-renews at 30 days).

### Live connectivity

All external hostnames tested via in-cluster `curl -sk` returned HTTP responses (auth redirects = 302), confirming the ingress chain is working. Local `openssl` could not reach external hostnames from outside (expected â€” Cloudflare Tunnel routes all external traffic).

---

## 10. Flux Security Posture

**Status: ğŸŸ¡ Warning**

| Check | Status |
|-------|--------|
| `sops-age` secret in `flux-system` | ğŸŸ¢ Present |
| GitHub webhook receiver has `secretRef` | ğŸŸ¢ `github-webhook-token-secret` |
| Git repository credentials in URL | ğŸŸ¢ None â€” uses `secretRef` or no auth |
| `flux-operator` has `cluster-admin` binding | ğŸŸ¡ Expected for GitOps operator but broad |
| SOPS `path_regex` coverage | ğŸŸ¢ `talos/**` and `kubernetes/**` â€” complete |

ğŸŸ¡ `flux-operator` having `cluster-admin` is standard for Flux deployments but means a compromised Flux controller has full cluster access. No actionable remediation for a homelab, but worth noting.

---

## 11. UniFi Network Security Audit

**Status: ğŸŸ¢ OK** *(partial â€” local session expired mid-run)*

| Check | Result |
|-------|--------|
| IDS/IPS events | ğŸŸ¢ None detected |
| Security-category events (EVT_IDS/FW/LU/WG) | ğŸŸ¢ None detected |
| Unadopted / unknown devices | ğŸŸ¢ All 10 devices adopted |
| New wireless clients (24h) | ğŸŸ¢ None |
| Blocked clients | ğŸŸ¢ None |
| WAN health | ğŸŸ¢ OK |

**All 10 managed devices confirmed adopted:**
DMP-CBERG, Basement-SW-48 PoE, Basement-SW-24-PoE, Living Room-01/02 SW-5, Guest Room USW SW-8, Basement-AP-U6+, Hallway-AP-U6 Pro, U7 Pro, Upstairs-AP-UAP AC LR

âš ï¸ UniFi local session expired before checking admin login logs. Re-run `unifictl local configure` to restore access.

---

## Summary Table

| Section | Status | Findings |
|---------|--------|----------|
| 1. SOPS Encryption Coverage | ğŸ”´ Critical | 2 plaintext Secret manifests, 1 ES Basic Auth hardcoded, 1 SOPS temp file on disk, 6 X-Proxy-Secret tokens in annotations |
| 2. Sensitive Data Exposure | ğŸŸ¢ OK | Domain/name/email not in tracked non-sops files |
| 3. Git History Secret Scan | ğŸŸ¡ Warning | 7 lines of domain in deleted history; 5 historically deleted secret files to verify |
| 4. CVE / Vulnerability Check | ğŸŸ¢ OK | 0 CVEs found (25 components checked) |
| 5. Authentik Login Analysis | ğŸŸ¢ OK | 0 failed login events in 7 days |
| 6. External Attack Patterns | ğŸŸ¢ OK | 0 attack patterns, 0 5xx errors in 24h |
| 7. RBAC & Pod Security | ğŸŸ¡ Warning | 8 app-namespace privileged/root containers (all likely intentional); 1 stale debug pod |
| 8. External Exposure Inventory | ğŸŸ¡ Warning | echo-server exposed externally; 5 services without Authentik auth layer |
| 9. Certificate Integrity | ğŸŸ¢ OK | Let's Encrypt wildcard, 35 days remaining, auto-renewal healthy |
| 10. Flux Security Posture | ğŸŸ¡ Warning | flux-operator has cluster-admin (standard but broad) |
| 11. UniFi Network Security | ğŸŸ¢ OK | No threats; partial run (session expired) |

---

## Priority Remediation Actions

### ğŸ”´ Immediate (within 24h)

1. **Delete SOPS temp file**: `rm kubernetes/apps/office/penpot/app/.decrypted~secret.sops.yaml`
2. **Encrypt langfuse clickhouse secret**: Convert `clickhouse.yaml` inline Secret to `clickhouse-secret.sops.yaml`
3. **Encrypt langfuse postgresql secret**: Convert `postgresql.yaml` inline Secret to `postgresql-secret.sops.yaml`
4. **Rotate tube-archivist Elasticsearch credential**: The `elastic:P9i4!...` password is committed in plaintext to a public repo â€” rotate it and store in SOPS

### ğŸŸ¡ Within a week

5. **Delete stale debug pod**: `kubectl delete pod node-debugger-k8s-nuc14-01-24zzs -n default`
6. **Remove or protect echo-server**: Either delete the external ingress or add Authentik auth annotation
7. **Review X-Proxy-Secret exposure**: 6 Authentik forward-auth tokens are committed in plaintext; consider rotating via new outpost deployments
8. **Verify historically deleted secret files**: Check git history for commits adding `kopia/secret.yaml`, `pgadmin/secret.yaml`, `langfuse/s3-credentials.yaml` to confirm they were SOPS-encrypted at time of commit
9. **Re-configure unifictl local session** for future audit runs

### ğŸŸ¢ Accepted / monitor

10. Application-level privileged containers (frigate, jellyfin, scrypted, makemkv, otbr) â€” all have hardware device access justification
11. `flux-operator` cluster-admin â€” standard for GitOps operator
12. External services without Authentik (open-webui, n8n, iobroker, tube-archivist, jellyfin) â€” acceptable if built-in auth is configured; document this decision
